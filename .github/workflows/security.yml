name: ðŸ”’ Security & Dependencies

on:
  schedule:
    - cron: '0 0 * * 1' # Weekly on Monday
  push:
    branches: [main]
    paths:
      - 'package*.json'
      - '.github/workflows/security.yml'
  workflow_dispatch:

concurrency:
  group: security-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ðŸ” Dependency vulnerability scan
  vulnerability-scan:
    name: ðŸ” Vulnerability Scan
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ðŸ” Run npm audit
        run: |
          npm audit --audit-level high --json > audit-results.json || true

          # Check if there are high/critical vulnerabilities
          HIGH_VULNS=$(cat audit-results.json | jq '.vulnerabilities | to_entries | map(select(.value.severity == "high" or .value.severity == "critical")) | length')

          if [ "$HIGH_VULNS" -gt 0 ]; then
            echo "âŒ Found $HIGH_VULNS high/critical vulnerabilities"
            npm audit --audit-level high
            exit 1
          else
            echo "âœ… No high/critical vulnerabilities found"
          fi

      - name: ðŸ“‹ Upload audit results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: audit-results
          path: audit-results.json

  # ðŸ›¡ï¸ Advanced security scanning with Snyk
  snyk-scan:
    name: ðŸ›¡ï¸ Snyk Security Scan
    runs-on: ubuntu-latest
    if: github.event_name != 'schedule' # Skip on scheduled runs to avoid rate limits
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ›¡ï¸ Run Snyk to check for vulnerabilities
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high

  # ðŸ“Š Dependency analysis
  dependency-review:
    name: ðŸ“Š Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“Š Dependency Review
        uses: actions/dependency-review-action@v3
        with:
          fail-on-severity: high
          allow-licenses: MIT, Apache-2.0, BSD-2-Clause, BSD-3-Clause, ISC

  # ðŸ”„ Automated dependency updates
  dependency-update:
    name: ðŸ”„ Update Dependencies
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ðŸ” Check for updates
        id: check-updates
        run: |
          npm outdated --json > outdated.json || true

          if [ -s outdated.json ]; then
            echo "updates_available=true" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ Updates available:"
            cat outdated.json | jq -r 'to_entries[] | "\(.key): \(.value.current) â†’ \(.value.latest)"'
          else
            echo "updates_available=false" >> $GITHUB_OUTPUT
            echo "âœ… All dependencies are up to date"
          fi

      - name: ðŸ”„ Update dependencies
        if: steps.check-updates.outputs.updates_available == 'true'
        run: |
          # Update patch and minor versions only (safer)
          npm update
          cd docs && npm update

          # Check if package-lock.json changed
          if git diff --quiet package-lock.json docs/package-lock.json; then
            echo "No changes to package-lock.json files"
          else
            echo "package_lock_changed=true" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ§ª Test after updates
        if: steps.check-updates.outputs.updates_available == 'true'
        run: |
          npm ci
          npm run test:run
          npm run build
          cd docs && npm ci && npm run build

      - name: ðŸ“‹ Create PR for dependency updates
        if: steps.check-updates.outputs.updates_available == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'ðŸ”„ chore(deps): update dependencies'
          title: 'ðŸ”„ Automated dependency updates'
          body: |
            ## ðŸ”„ Automated Dependency Updates

            This PR contains automated dependency updates:

            ### Changes
            - Updated patch and minor versions of dependencies
            - Verified all tests pass with new versions
            - Built successfully with updated dependencies

            ### Review Notes
            - ðŸ§ª All tests are passing
            - ðŸ—ï¸ Build is successful
            - ðŸ” Security scan completed

            Please review the changes and merge if everything looks good.

            ---
            *This PR was created automatically by the dependency update workflow*
          branch: automated/dependency-updates
          delete-branch: true

  # ðŸ—‚ï¸ License compliance check
  license-check:
    name: ðŸ—‚ï¸ License Compliance
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ðŸ—ï¸ Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ðŸ—‚ï¸ Check licenses
        run: |
          # Install license checker
          npm install -g license-checker

          # Generate license report
          license-checker --json --out licenses.json

          # Check for problematic licenses
          PROBLEMATIC_LICENSES=$(cat licenses.json | jq -r 'to_entries[] | select(.value.licenses | test("GPL|AGPL|SSPL|BCL")) | .key')

          if [ -n "$PROBLEMATIC_LICENSES" ]; then
            echo "âŒ Found packages with problematic licenses:"
            echo "$PROBLEMATIC_LICENSES"
            exit 1
          else
            echo "âœ… All licenses are compliant"
          fi

      - name: ðŸ“‹ Upload license report
        uses: actions/upload-artifact@v3
        with:
          name: license-report
          path: licenses.json

  # ðŸ“ˆ Security reporting
  security-report:
    name: ðŸ“ˆ Security Report
    runs-on: ubuntu-latest
    needs: [vulnerability-scan, license-check]
    if: always()
    steps:
      - name: ðŸ“¥ Download artifacts
        uses: actions/download-artifact@v3
        with:
          path: artifacts

      - name: ðŸ“ˆ Generate security summary
        run: |
          echo "# ðŸ”’ Security Summary" > security-summary.md
          echo "" >> security-summary.md
          echo "## Vulnerability Scan" >> security-summary.md

          if [ "${{ needs.vulnerability-scan.result }}" == "success" ]; then
            echo "âœ… **PASSED** - No high/critical vulnerabilities found" >> security-summary.md
          else
            echo "âŒ **FAILED** - High/critical vulnerabilities detected" >> security-summary.md
          fi

          echo "" >> security-summary.md
          echo "## License Compliance" >> security-summary.md

          if [ "${{ needs.license-check.result }}" == "success" ]; then
            echo "âœ… **PASSED** - All licenses are compliant" >> security-summary.md
          else
            echo "âŒ **FAILED** - Problematic licenses detected" >> security-summary.md
          fi

          echo "" >> security-summary.md
          echo "Generated on: $(date)" >> security-summary.md

      - name: ðŸ“‹ Upload security summary
        uses: actions/upload-artifact@v3
        with:
          name: security-summary
          path: security-summary.md
